<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinUCç§èŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background-color: #12b7f5;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: normal;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: #eaeaea;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        .user-info {
            padding: 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .user-info span {
            display: flex;
            align-items: center;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #12b7f5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 10px;
        }
        
        .logout-btn {
            background-color: #e6e6e6;
            color: #666;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: #d9d9d9;
        }
        
        .tabs {
            display: flex;
            background-color: #fafafa;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background-color: #f0f0f0;
        }
        
        .tab.active {
            font-weight: bold;
            color: #12b7f5;
            border-bottom: 2px solid #12b7f5;
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            background-color: #fafafa;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            padding: 10px;
            position: relative;
            background-color: #fafafa;
            border-bottom: 1px solid #ddd;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 10px 8px 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            left: 18px;
            top: 18px;
            color: #999;
        }
        
        .chats-list, .online-users {
            flex: 1;
            overflow-y: auto;
        }
        
        .chat-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .chat-item:hover {
            background-color: #f0f0f0;
        }
        
        .chat-item.active {
            background-color: #e6f7ff;
        }
        
        .chat-item .avatar {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .chat-item .content {
            flex: 1;
            min-width: 0;
        }
        
        .chat-item .name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-item .last-message {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .chat-item .time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-item .status {
            font-size: 12px;
            color: #52c41a;
            margin-top: 5px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }
        
        .chat-header {
            padding: 15px;
            background-color: #fafafa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .chat-header-title {
            font-size: 16px;
        }
        
        .chat-tools {
            display: flex;
            gap: 15px;
        }
        
        .chat-tool {
            cursor: pointer;
            color: #666;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f5f5f5;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEvklEQVR4nO2ZbYhUVRjHnzNzZ93Z2d1Zd2ZnZtcdd1/UzLd8yUwJzA8FghTRF6EvGSRR2RtFEESfMsqSDCnDsqjEKPpSUpEmFZVGEsqHkKQPA0mWrrvr7szOy71P/3Nm7rq77L3r3plx3eF54Fx25p5z/+d5zvOcc+4wlqMc/+Owc7mQpumF1Wp1OaV0K6X0JcbYEULILwT8JAi5TQjZTwh5iRCyQVGUpaqqlok8cN3SIsuyBliWtYRSepAQ8ifP8x7HcUJ5cFxkWRb1PE+AD8/z11RV3SxJ0kxFUSw2VjiOswCM2O32uCiKsizL6cDAQB//n+D7fr9t2+lisZj2PC9TLBYztVot7Xnel67rfspx3FFCSAVW7rqx7FKapg10XfezVCqV9jxvliAIVF1dvfjfV8jojQDvJEnS7e7u/jKZTOY9z5sXQRhjfzHGfieE3I5C/46x2YmmaW/iYtF1/a1MJvM+5qRMJpPJ5/OZXbt2ZR944IFMLpcbK9MrR6NR1IjAEJmh6tgrJEki0Wi0Q5blZ6urqwXXdYvhyqmq+mZbW9udQ0NDq6qqqilVVadUqampuq5PxYdlWSMYYz9ijB27AEMYR/Bf9BMbqqenZ/T48eP333TTTWdlWT7HcdzFZkMYY8cwxqcJIUcopcfGgzF2Bv0QQvZhjLeKorjGtu17NE2bZRjGNMMwpqObgZBiHT3jJhEEYb9pmnva29sfNQzjfkVRPoAVCAPPnj37XUdHxytbtmx5aGho6JaBgYFL+vr6+nt7e6e2tLRcqijK7aZpnpIk6RQh5G+O4xQRfNwKMiK4HEf3AH60t7dvwRgf4HleZYwdRf+u6/qHx44d2zw8PDzf9/10LBZr8zyv0/O8RY7jrHYc51HHcY4SQi5RSq+EQReaeYMgjLHLqVRqvaZp7S0tLRcVi8WXOzo6vshms5hSupwN7ZohhPwSfLi/efPmJ4eHh+9TVXWGLMsxWZZj+MiyHFcUZSalNKmq6lzDMD40TfNUPB6/Hrl3rZCmacZnGMY7oPw9e/ZM6+zs3MQY2yvLcpHjOJUxdhp5DQ8Pzzhw4MA9lmVdXy6X26urq2v9hgf6DZ5Z1/X5hJAeoMXWqYsiyrLcoarqlxs2bHiwqalpo6Iou3ie72KM9aM/x3HeGBgYmFUqlVahsFprj2O8qxn2U1xcisXiuzNnzrwtaqS6uvpJXddPcxzXyRiLcRzXvWbNmlWlUuldRVFuVBQlHolEouAHeCZCiKKqaiPHcX+gxhzH0caaBb6BHblVeGwYxt5wLDQ0NJywLGsMX5TS3+rq6p6rrq6Wm70O8bpWKYoyD3GQN6kRhUIhnslkOiORCJFlWZNluREfkPeMsVg+n3+5WCzOZFfxWbduHR8fKmBEluX9FRxRkdXW1hbe9Xq9P6DgBdz1MPcqaV8PY+wI5gVBEL7xPC8FtcIY20sIOVl+c2rHUKlU4pubm+eqqvrpFSrb4/F4wd/jL0a5vb19+7p16/zGhH1GGGN/btu2bR7S7kpGlHK5PLvEwQ6Z53keGxGMJfiO530c7O8bLxc+zsTcQil9vJQv+/v7Vcuy6JgRcB0sFDlQnqSUznLd8uNGxzETDA7nxFM5ylEO9rfxD7Hh2z1YrQxaAAAAAElFTkSuQmCC');
            background-repeat: repeat;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            max-width: 70%;
        }
        
        .message .sender {
            font-size: 13px;
            color: #999;
            margin-bottom: 5px;
        }
        
        .message .content-wrapper {
            display: flex;
            align-items: flex-end;
        }
        
        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .message .avatar.right {
            margin-right: 0;
            margin-left: 10px;
            order: 1;
        }
        
        .message .bubble {
            position: relative;
            padding: 10px 15px;
            border-radius: 4px;
            max-width: calc(100% - 50px);
            word-break: break-word;
        }
        
        .message .time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            margin-left: 50px;
        }
        
        .message.received .time {
            text-align: left;
        }
        
        .message.sent .time {
            text-align: right;
            margin-right: 50px;
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message.sent {
            align-self: flex-end;
        }
        
        .message.received .bubble {
            background-color: white;
            border: 1px solid #e6e6e6;
        }
        
        .message.received .bubble:before {
            content: "";
            position: absolute;
            top: 15px;
            left: -8px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-right: 8px solid white;
            border-bottom: 8px solid transparent;
        }
        
        .message.sent .bubble {
            background-color: #95ec69;
            color: #000;
        }
        
        .message.sent .bubble:before {
            content: "";
            position: absolute;
            top: 15px;
            right: -8px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-left: 8px solid #95ec69;
            border-bottom: 8px solid transparent;
        }
        
        .input-area {
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
            border-top: 1px solid #ddd;
        }
        
        .toolbar {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .tool-btn {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            background-color: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tool-btn:hover {
            background-color: #eee;
        }
        
        .input-wrapper {
            display: flex;
            padding: 10px;
        }
        
        .input-box {
            flex: 1;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            resize: none;
            font-size: 14px;
        }
        
        .send-btn {
            width: 80px;
            margin-left: 10px;
            background-color: #12b7f5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .send-btn:hover {
            background-color: #10a5e0;
        }
        
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .auth-box {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: 20px;
            color: #333;
        }
        
        .auth-input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .auth-input:focus {
            border-color: #12b7f5;
        }
        
        .auth-btn {
            width: 100%;
            padding: 12px;
            background-color: #12b7f5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        
        .auth-btn:hover {
            background-color: #10a5e0;
        }
        
        .error-message {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #cf1322;
            display: none;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .auth-switch a {
            color: #12b7f5;
            cursor: pointer;
            text-decoration: none;
        }
        
        .auth-switch a:hover {
            text-decoration: underline;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                height: 100%;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-toggle {
                display: block;
                position: absolute;
                left: 10px;
                top: 15px;
                font-size: 20px;
                color: white;
                cursor: pointer;
            }
            
            .header h1 {
                margin-left: 40px;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-toggle">â˜°</div>
    <div class="header">
        <h1>WinUC èŠå¤©</h1>
        <div id="headerUserInfo"></div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="user-info" id="currentUserInfo">
                <!-- ç”¨æˆ·ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="chats">èŠå¤©ä¼šè¯</div>
                <div class="tab" data-tab="users">åœ¨çº¿å¥½å‹</div>
            </div>
            
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" placeholder="æœç´¢èŠå¤©æˆ–å¥½å‹...">
            </div>
            
            <div class="tab-content active" id="chats-content">
                <div class="chats-list" id="chatSessionsContainer">
                    <!-- èŠå¤©ä¼šè¯åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
            
            <div class="tab-content" id="users-content">
                <div class="online-users" id="onlineUsersContainer">
                    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-title" id="chatHeader">é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©</div>
                <div class="chat-tools">
                    <span class="chat-tool">ğŸ“</span>
                    <span class="chat-tool">ğŸ“·</span>
                    <span class="chat-tool">â‹®</span>
                </div>
            </div>
            <div class="messages" id="messages">
                <!-- è¿™é‡Œå°†æ˜¾ç¤ºæ¶ˆæ¯ -->
            </div>
            <div class="input-area">
                <div class="toolbar">
                    <button class="tool-btn">ğŸ˜Š</button>
                    <button class="tool-btn">ğŸ–¼ï¸</button>
                    <button class="tool-btn">ğŸ“</button>
                    <button class="tool-btn">ğŸ“</button>
                </div>
                <div class="input-wrapper">
                    <textarea class="input-box" id="messageInput" placeholder="è¯·è¾“å…¥æ¶ˆæ¯..."></textarea>
                    <button class="send-btn" id="sendBtn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•è¡¨å• -->
    <div class="auth-container" id="loginContainer">
        <div class="auth-box">
            <div class="auth-title">ç™»å½• WinUC èŠå¤©</div>
            <div class="error-message" id="loginError"></div>
            <input type="text" class="auth-input" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <input type="password" class="auth-input" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button class="auth-btn" id="loginBtn">ç™» å½•</button>
            <div class="auth-switch">
                æ²¡æœ‰è´¦å·ï¼Ÿ<a id="showRegister">ç«‹å³æ³¨å†Œ</a>
            </div>
        </div>
    </div>
    
    <!-- æ³¨å†Œè¡¨å• -->
    <div class="auth-container" id="registerContainer" style="display:none;">
        <div class="auth-box">
            <div class="auth-title">æ³¨å†Œ WinUC è´¦å·</div>
            <div class="error-message" id="registerError"></div>
            <input type="text" class="auth-input" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <input type="password" class="auth-input" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button class="auth-btn" id="registerBtn">æ³¨ å†Œ</button>
            <div class="auth-switch">
                å·²æœ‰è´¦å·ï¼Ÿ<a id="showLogin">ç«‹å³ç™»å½•</a>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // è·å–DOMå…ƒç´ 
            const messagesContainer = document.getElementById('messages');
            const chatHeader = document.getElementById('chatHeader');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const onlineUsersContainer = document.getElementById('onlineUsersContainer');
            const chatSessionsContainer = document.getElementById('chatSessionsContainer');
            const loginContainer = document.getElementById('loginContainer');
            const registerContainer = document.getElementById('registerContainer');
            const loginUsernameInput = document.getElementById('loginUsername');
            const loginPasswordInput = document.getElementById('loginPassword');
            const registerUsernameInput = document.getElementById('registerUsername');
            const registerPasswordInput = document.getElementById('registerPassword');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const showRegisterLink = document.getElementById('showRegister');
            const showLoginLink = document.getElementById('showLogin');
            const loginError = document.getElementById('loginError');
            const registerError = document.getElementById('registerError');
            const currentUserInfo = document.getElementById('currentUserInfo');
            const headerUserInfo = document.getElementById('headerUserInfo');
            const mobileToggle = document.querySelector('.mobile-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            // å“åº”å¼è®¾è®¡ - ä¾§è¾¹æ åˆ‡æ¢
            if (mobileToggle) {
                mobileToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                });
            }
            
            // ä¿å­˜JWTä»¤ç‰Œ
            let token = localStorage.getItem('chat_token');
            // Socket.IOè¿æ¥
            let socket = null;
            // å½“å‰ç”¨æˆ·ä¿¡æ¯
            let currentUser = null;
            // å½“å‰é€‰ä¸­çš„èŠå¤©å¯¹è±¡
            let currentChatTarget = null;
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError(element, message) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
            
            // ç”¨æˆ·æ³¨å†Œ
            async function register() {
                const username = registerUsernameInput.value.trim();
                const password = registerPasswordInput.value.trim();
                
                if (!username || !password) {
                    showError(registerError, 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                try {
                    const response = await fetch('/api/users/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showError(registerError, data.error || 'æ³¨å†Œå¤±è´¥');
                        return;
                    }
                    
                    // æ³¨å†ŒæˆåŠŸï¼Œä¿å­˜Token
                    token = data.token;
                    localStorage.setItem('chat_token', token);
                    
                    // è·å–ç”¨æˆ·ä¿¡æ¯
                    await getUserInfo();
                    
                    // è¿æ¥Socket
                    connectToChat();
                    
                    // åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨
                    loadChatSessions();
                    
                    // éšè—æ³¨å†Œè¡¨å•
                    registerContainer.style.display = 'none';
                } catch (error) {
                    console.error('æ³¨å†Œå¤±è´¥:', error);
                    showError(registerError, 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                }
            }
            
            // ç”¨æˆ·ç™»å½•
            async function login() {
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value.trim();
                
                if (!username || !password) {
                    showError(loginError, 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                try {
                    const response = await fetch('/api/users/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showError(loginError, data.error || 'ç™»å½•å¤±è´¥');
                        return;
                    }
                    
                    // ç™»å½•æˆåŠŸï¼Œä¿å­˜Token
                    token = data.token;
                    localStorage.setItem('chat_token', token);
                    
                    // è·å–ç”¨æˆ·ä¿¡æ¯
                    await getUserInfo();
                    
                    // è¿æ¥Socket
                    connectToChat();
                    
                    // åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨
                    loadChatSessions();
                    
                    // éšè—ç™»å½•è¡¨å•
                    loginContainer.style.display = 'none';
                } catch (error) {
                    console.error('ç™»å½•å¤±è´¥:', error);
                    showError(loginError, 'ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                }
            }
            
            // è·å–ç”¨æˆ·åé¦–å­—æ¯ä½œä¸ºå¤´åƒ
            function getAvatarText(username) {
                return username ? username.charAt(0).toUpperCase() : '?';
            }
            
            // ç”Ÿæˆéšæœºé¢œè‰²ä½œä¸ºå¤´åƒèƒŒæ™¯
            function getAvatarColor(userId) {
                const colors = ['#12b7f5', '#f56a12', '#1296f5', '#f51296', '#7d12f5', '#12f594'];
                const index = userId ? parseInt(userId.charAt(0), 16) % colors.length : 0;
                return colors[index];
            }
            
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            async function getUserInfo() {
                try {
                    const response = await fetch('/api/users/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    currentUser = data;
                    
                    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                    const avatarText = getAvatarText(currentUser.username);
                    const avatarColor = getAvatarColor(currentUser.userId);
                    
                    currentUserInfo.innerHTML = `
                        <span>
                            <div class="avatar" style="background-color: ${avatarColor};">${avatarText}</div>
                            ${currentUser.username}
                        </span>
                        <button class="logout-btn" id="logoutBtn">é€€å‡º</button>
                    `;
                    
                    headerUserInfo.innerHTML = `å·²ç™»å½•: ${currentUser.username}`;
                    
                    // æ·»åŠ é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    document.getElementById('logoutBtn').addEventListener('click', logout);
                    
                    return data;
                } catch (error) {
                    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    // æ¸…é™¤æ— æ•ˆçš„Token
                    token = null;
                    localStorage.removeItem('chat_token');
                    return null;
                }
            }
            
            // é€€å‡ºç™»å½•
            function logout() {
                // æ¸…é™¤Token
                token = null;
                localStorage.removeItem('chat_token');
                currentUser = null;
                
                // æ–­å¼€Socketè¿æ¥
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
                
                // æ¸…ç©ºèŠå¤©è®°å½•å’Œç”¨æˆ·åˆ—è¡¨
                messagesContainer.innerHTML = '';
                onlineUsersContainer.innerHTML = '';
                chatSessionsContainer.innerHTML = '';
                currentUserInfo.innerHTML = '';
                headerUserInfo.innerHTML = '';
                chatHeader.textContent = 'é€‰æ‹©ä¸€ä¸ªè”ç³»äººå¼€å§‹èŠå¤©';
                
                // æ˜¾ç¤ºç™»å½•è¡¨å•
                loginContainer.style.display = 'flex';
            }
            
            // è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨
            function connectToChat() {
                if (!token) return;
                
                // åˆ›å»ºSocket.IOè¿æ¥
                socket = io();
                
                // è¿æ¥æˆåŠŸåè¿›è¡ŒTokenéªŒè¯
                socket.on('connect', () => {
                    console.log('å·²è¿æ¥åˆ°Socket.IOæœåŠ¡å™¨');
                    
                    // å‘é€joinäº‹ä»¶å¹¶ä¼ é€’Tokenè¿›è¡ŒéªŒè¯
                    socket.emit('join', { token });
                });
                
                // è¿æ¥é”™è¯¯å¤„ç†
                socket.on('connect_error', (error) => {
                    console.error('Socketè¿æ¥å¤±è´¥:', error);
                    showError(loginError, 'è¿æ¥èŠå¤©æœåŠ¡å™¨å¤±è´¥');
                });
                
                // è®¤è¯æˆåŠŸäº‹ä»¶
                socket.on('auth_success', (userData) => {
                    console.log('è®¤è¯æˆåŠŸ:', userData);
                    loadOnlineUsers();  // åŠ è½½åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                });
                
                // è®¤è¯å¤±è´¥äº‹ä»¶
                socket.on('auth_error', (error) => {
                    console.error('è®¤è¯å¤±è´¥:', error);
                    showError(loginError, error.message || 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    logout();
                });
                
                // æ¥æ”¶ç§èŠæ¶ˆæ¯
                socket.on('privateMessage', (message) => {
                    // åˆ¤æ–­æ¶ˆæ¯æ˜¯å½“å‰èŠå¤©å¯¹è±¡çš„ï¼Œæˆ–æ˜¯è‡ªå·±å‘é€çš„
                    const isCurrentChat = (currentChatTarget && 
                                          (message.senderId === currentChatTarget.userId || 
                                           message.receiverId === currentChatTarget.userId));
                    
                    if (isCurrentChat) {
                        addPrivateMessage(message);
                    }
                    
                    // æ›´æ–°ä¼šè¯åˆ—è¡¨
                    loadChatSessions();
                });
                
                // åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ›´æ–°
                socket.on('userList', (users) => {
                    updateOnlineUsers(users);
                });
                
                // æ–­å¼€è¿æ¥å¤„ç†
                socket.on('disconnect', () => {
                    console.log('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                });
            }
            
            // åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨
            async function loadChatSessions() {
                try {
                    const response = await fetch('/api/private-chats', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    
                    // æ¸…ç©ºä¼šè¯å®¹å™¨
                    chatSessionsContainer.innerHTML = '';
                    
                    // æ·»åŠ ä¼šè¯åˆ—è¡¨
                    if (data.sessions && data.sessions.length > 0) {
                        data.sessions.forEach(session => {
                            const avatarText = getAvatarText(session.username);
                            const avatarColor = getAvatarColor(session.userId);
                            const sessionEl = document.createElement('div');
                            sessionEl.className = 'chat-item';
                            
                            if (currentChatTarget && session.userId === currentChatTarget.userId) {
                                sessionEl.classList.add('active');
                            }
                            
                            sessionEl.innerHTML = `
                                <div class="avatar" style="background-color: ${avatarColor};">${avatarText}</div>
                                <div class="content">
                                    <div class="name">${session.username}</div>
                                    <div class="last-message">${session.lastMessage}</div>
                                </div>
                                <div class="time">${formatRelativeTime(new Date(session.lastTime))}</div>
                            `;
                            
                            sessionEl.onclick = () => {
                                // è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡
                                currentChatTarget = {
                                    userId: session.userId,
                                    username: session.username
                                };
                                
                                // åŠ è½½ä¸è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
                                loadPrivateMessages(session.userId);
                                
                                // æ›´æ–°UI
                                updateChatHeader(session.username);
                                
                                // æ ‡è®°å½“å‰æ´»åŠ¨ä¼šè¯
                                document.querySelectorAll('.chat-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                sessionEl.classList.add('active');
                                
                                // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œç‚¹å‡»ä¼šè¯åéšè—ä¾§è¾¹æ 
                                if (window.innerWidth <= 768) {
                                    sidebar.classList.remove('active');
                                }
                            };
                            
                            chatSessionsContainer.appendChild(sessionEl);
                        });
                    } else {
                        chatSessionsContainer.innerHTML = '<div class="chat-item" style="justify-content: center; color: #999;">æš‚æ— ç§èŠä¼šè¯</div>';
                    }
                } catch (error) {
                    console.error('åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                }
            }
            
            // åŠ è½½ä¸ç‰¹å®šç”¨æˆ·çš„ç§èŠæ¶ˆæ¯
            async function loadPrivateMessages(targetUserId) {
                try {
                    const response = await fetch(`/api/private-chats/${targetUserId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('åŠ è½½ç§èŠæ¶ˆæ¯å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    
                    // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
                    messagesContainer.innerHTML = '';
                    
                    // æŒ‰æ—¶é—´é¡ºåºæ·»åŠ æ¶ˆæ¯
                    const messages = data.messages;
                    messages.reverse().forEach(message => {
                        addPrivateMessage(message);
                    });
                    
                    // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } catch (error) {
                    console.error('åŠ è½½ç§èŠæ¶ˆæ¯å¤±è´¥:', error);
                }
            }
            
            // å‘é€ç§èŠæ¶ˆæ¯
            async function sendPrivateMessage() {
                const content = messageInput.value.trim();
                
                if (!content || !currentChatTarget || !socket) return;
                
                try {
                    // é€šè¿‡HTTP APIå‘é€ç§èŠæ¶ˆæ¯
                    const response = await fetch(`/api/private-chats/${currentChatTarget.userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ content })
                    });
                    
                    if (!response.ok) {
                        throw new Error('å‘é€ç§èŠæ¶ˆæ¯å¤±è´¥');
                    }
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    messageInput.value = '';
                    
                    // å› ä¸ºæ¶ˆæ¯ä¼šé€šè¿‡Socket.IOçš„privateMessageäº‹ä»¶æ¥æ”¶åˆ°ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
                } catch (error) {
                    console.error('å‘é€ç§èŠæ¶ˆæ¯å¤±è´¥:', error);
                    alert('å‘é€ç§èŠæ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
            
            // æ·»åŠ ç§èŠæ¶ˆæ¯åˆ°ç•Œé¢
            function addPrivateMessage(message) {
                const messageEl = document.createElement('div');
                
                // åˆ¤æ–­æ˜¯è‡ªå·±å‘é€çš„è¿˜æ˜¯æ¥æ”¶çš„
                const isSent = message.senderId === currentUser.userId;
                messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
                
                // è·å–å‘é€è€…å¤´åƒ
                const senderAvatarText = isSent ? 
                    getAvatarText(currentUser.username) : 
                    getAvatarText(message.sender);
                
                const senderAvatarColor = isSent ?
                    getAvatarColor(currentUser.userId) :
                    getAvatarColor(message.senderId);
                
                // æ„å»ºæ¶ˆæ¯å†…å®¹
                messageEl.innerHTML = `
                    <div class="content-wrapper">
                        <div class="avatar ${isSent ? 'right' : ''}" style="background-color: ${senderAvatarColor};">${senderAvatarText}</div>
                        <div class="bubble">${message.content}</div>
                    </div>
                    <div class="time">${formatTime(new Date(message.time))}</div>
                `;
                
                // æ·»åŠ åˆ°æ¶ˆæ¯å®¹å™¨å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // æ ¼å¼åŒ–æ—¶é—´ (HH:MM)
            function formatTime(date) {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            
            // æ ¼å¼åŒ–ç›¸å¯¹æ—¶é—´ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æ—¥æœŸï¼‰
            function formatRelativeTime(date) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date >= today) {
                    return formatTime(date);
                } else if (date >= yesterday) {
                    return 'æ˜¨å¤©';
                } else {
                    // æ˜¾ç¤ºæœˆ-æ—¥
                    return `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                }
            }
            
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            function updateOnlineUsers(users) {
                const onlineUsersContainer = document.getElementById('onlineUsersContainer');
                onlineUsersContainer.innerHTML = '';
                
                if (users && users.length > 0) {
                    users.forEach(user => {
                        // ä¸æ˜¾ç¤ºå½“å‰ç”¨æˆ·è‡ªå·±
                        if (currentUser && user.userId === currentUser.userId) return;
                        
                        const avatarText = getAvatarText(user.username);
                        const avatarColor = getAvatarColor(user.userId);
                        
                        const userEl = document.createElement('div');
                        userEl.className = 'chat-item';
                        userEl.innerHTML = `
                            <div class="avatar" style="background-color: ${avatarColor};">${avatarText}</div>
                            <div class="content">
                                <div class="name">${user.username}</div>
                                <div class="status">åœ¨çº¿</div>
                            </div>
                        `;
                        
                        userEl.onclick = () => {
                            // è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡
                            currentChatTarget = {
                                userId: user.userId,
                                username: user.username
                            };
                            
                            // å°è¯•åŠ è½½ä¸è¯¥ç”¨æˆ·çš„èŠå¤©è®°å½•
                            loadPrivateMessages(user.userId);
                            
                            // æ›´æ–°UI
                            updateChatHeader(user.username);
                            
                            // åˆ‡æ¢åˆ°èŠå¤©æ ‡ç­¾
                            tabs[0].click();
                            
                            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œç‚¹å‡»ä¼šè¯åéšè—ä¾§è¾¹æ 
                            if (window.innerWidth <= 768) {
                                sidebar.classList.remove('active');
                            }
                        };
                        
                        onlineUsersContainer.appendChild(userEl);
                    });
                } else {
                    onlineUsersContainer.innerHTML = '<div class="chat-item" style="justify-content: center; color: #999;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
                }
            }
            
            // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            async function loadOnlineUsers() {
                try {
                    const response = await fetch('/api/users/online', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    updateOnlineUsers(data.users);
                } catch (error) {
                    console.error('è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                }
            }
            
            // æ›´æ–°èŠå¤©çª—å£æ ‡é¢˜
            function updateChatHeader(username) {
                chatHeader.textContent = `æ­£åœ¨ä¸ ${username} èŠå¤©`;
            }
            
            // åˆå§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            function init() {
                if (token) {
                    // å°è¯•ç”¨å·²ä¿å­˜çš„Tokenè¿æ¥
                    getUserInfo().then(user => {
                        if (user) {
                            // æœ‰æ•ˆçš„Tokenï¼Œè¿æ¥èŠå¤©
                            connectToChat();
                            loginContainer.style.display = 'none';
                            
                            // åŠ è½½ç§èŠä¼šè¯åˆ—è¡¨
                            loadChatSessions();
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰å®šçš„èŠå¤©ç›®æ ‡ï¼ˆä»ä¸»é¡µç‚¹å‡»ç”¨æˆ·ä¼ é€’è¿‡æ¥ï¼‰
                            const storedTarget = sessionStorage.getItem('privateChatTarget');
                            if (storedTarget) {
                                try {
                                    const targetData = JSON.parse(storedTarget);
                                    currentChatTarget = targetData;
                                    
                                    // åŠ è½½ä¸ç›®æ ‡ç”¨æˆ·çš„èŠå¤©è®°å½•
                                    loadPrivateMessages(targetData.userId);
                                    
                                    // æ›´æ–°UI
                                    updateChatHeader(targetData.username);
                                    
                                    // æ¸…é™¤ä¼šè¯å­˜å‚¨ä¸­çš„æ•°æ®ï¼Œé¿å…åˆ·æ–°é¡µé¢åå†æ¬¡åŠ è½½
                                    sessionStorage.removeItem('privateChatTarget');
                                } catch (error) {
                                    console.error('å¤„ç†èŠå¤©ç›®æ ‡æ•°æ®å¤±è´¥:', error);
                                }
                            }
                        } else {
                            // æ— æ•ˆçš„Tokenï¼Œæ˜¾ç¤ºç™»å½•è¡¨å•
                            loginContainer.style.display = 'flex';
                        }
                    });
                } else {
                    // æ²¡æœ‰Tokenï¼Œæ˜¾ç¤ºç™»å½•è¡¨å•
                    loginContainer.style.display = 'flex';
                }
            }

            // æ·»åŠ è¿”å›ä¸»èŠå¤©å®¤çš„é“¾æ¥
            const headerTitle = document.querySelector('.header h1');
            headerTitle.innerHTML = `<a href="/" style="color: white; text-decoration: none;">WinUCç§èŠ</a>`;
            
            // ç»‘å®šå‘é€æ¶ˆæ¯äº‹ä»¶
            sendBtn.addEventListener('click', sendPrivateMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // ç»‘å®šç™»å½•äº‹ä»¶
            loginBtn.addEventListener('click', login);
            
            // ç»‘å®šæ³¨å†Œäº‹ä»¶
            registerBtn.addEventListener('click', register);
            
            // ç»‘å®šè¡¨å•åˆ‡æ¢äº‹ä»¶
            showRegisterLink.addEventListener('click', () => {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'flex';
            });
            
            showLoginLink.addEventListener('click', () => {
                registerContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
            });
            
            // åˆ‡æ¢æ ‡ç­¾é¡µ
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„æ´»åŠ¨çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    // æ·»åŠ å½“å‰æ ‡ç­¾é¡µçš„æ´»åŠ¨çŠ¶æ€
                    tab.classList.add('active');
                    
                    // è·å–ç›®æ ‡æ ‡ç­¾é¡µå†…å®¹ID
                    const targetId = tab.getAttribute('data-tab') + '-content';
                    
                    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µå†…å®¹
                    document.getElementById(targetId).classList.add('active');
                });
            });
            
            // åˆå§‹åŒ–åº”ç”¨
            init();
            
            // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            setInterval(() => {
                if (token && socket && socket.connected) {
                    loadOnlineUsers();
                }
            }, 30000);
        });
    </script>
</body>
</html> 